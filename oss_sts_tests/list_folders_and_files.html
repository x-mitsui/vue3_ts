<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OSSæ–‡ä»¶æµè§ˆå™¨</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    .breadcrumb {
      margin: 15px 0;
      font-size: 14px;
    }

    .breadcrumb a {
      color: #06c;
      text-decoration: none;
    }

    .file-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .file-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
    }

    .file-item:hover {
      background-color: #f9f9f9;
    }

    .file-icon {
      margin-right: 10px;
      width: 24px;
      text-align: center;
    }

    .folder-icon {
      color: #ffb700;
    }

    .file-name {
      flex: 1;
    }

    .file-size {
      color: #666;
      font-size: 13px;
      min-width: 80px;
      text-align: right;
    }

    .file-actions a {
      margin-left: 10px;
      color: #06c;
      text-decoration: none;
      font-size: 13px;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .error {
      color: #d32f2f;
      padding: 10px;
      background: #ffebee;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>OSSæ–‡ä»¶æµè§ˆå™¨</h1>
    <div class="breadcrumb" id="breadcrumb">
      <a href="javascript:void(0)" onclick="listFiles('')">æ ¹ç›®å½•</a>
    </div>

    <div id="file-list-container">
      <div class="loading">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <script src="https://gosspublic.alicdn.com/aliyun-oss-sdk-6.18.0.min.js"></script>
  <script>
    // å…¨å±€å˜é‡
    let ossClient = null;
    let currentPath = '';

    // è·å–STS Token
    const getOSSToken = async () => {
      const res = await fetch('http://192.168.9.47:3001/cms/file/sts');
      const data = await res.json();
      console.log(data);

      // æ£€æŸ¥Tokenæœ‰æ•ˆæœŸ
      const expiresIn = new Date(data.data.expiration).getTime() - Date.now();
      console.log(`Tokenå‰©ä½™æœ‰æ•ˆæœŸ: ${expiresIn / 1000}ç§’`);

      if (expiresIn <= 0) {
        throw new Error('STS Tokenå·²è¿‡æœŸ');
      }
      return data.data;
    };

    // åˆå§‹åŒ–OSSå®¢æˆ·ç«¯
    const getAliOssClient = async () => {
      if (ossClient) return ossClient;
      const data = await getOSSToken();
      ossClient = new OSS({
        region: data.region,
        bucket: data.bucket,
        accessKeyId: data.accessKeyId,
        accessKeySecret: data.accessKeySecret,
        stsToken: data.securityToken,
        authorizationV4: true,
        timeout: 60000,
        refreshSTSToken: async () => {
          const info = await getOSSToken();
          return {
            accessKeyId: info.accessKeyId,
            accessKeySecret: info.accessKeySecret,
            stsToken: info.securityToken
          };
        },
        refreshSTSTokenInterval: 300000, // 5åˆ†é’Ÿåˆ·æ–°
        secure: true
      });
      return ossClient;
    };

    // åˆ—å‡ºæ–‡ä»¶
    const listFiles = async (prefix = '') => {
      try {
        currentPath = prefix;
        updateBreadcrumb(prefix);

        const container = document.getElementById('file-list-container');
        container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

        const client = await getAliOssClient();
        let result = await client.list({
          prefix: prefix,
          delimiter: '/',
          'max-keys': 100
        });

        // å¤„ç†æ–‡ä»¶å¤¹å’Œæ–‡ä»¶
        let content = '<ul class="file-list">';

        // 1. æ˜¾ç¤ºä¸Šçº§ç›®å½•é“¾æ¥ï¼ˆå¦‚æœä¸æ˜¯æ ¹ç›®å½•ï¼‰
        if (prefix) {
          const parentPath = prefix.replace(/[^\/]+\/$/, '');
          content += `
                <li class="file-item" onclick="listFiles('${parentPath}')">
                    <div class="file-icon">ğŸ“</div>
                    <div class="file-name">.. (ä¸Šçº§ç›®å½•)</div>
                    <div class="file-size"></div>
                    <div class="file-actions"></div>
                </li>
            `;
        }

        // 2. å®‰å…¨å¤„ç†å­æ–‡ä»¶å¤¹ï¼ˆä¿®å¤é”™è¯¯çš„æ ¸å¿ƒéƒ¨åˆ†ï¼‰
        const folders = result.prefixes || []; // ç¡®ä¿å§‹ç»ˆæ˜¯æ•°ç»„
        folders.forEach(folder => {
          content += `
                <li class="file-item" onclick="listFiles('${folder}')">
                    <div class="file-icon folder-icon">ğŸ“</div>
                    <div class="file-name">${folder.replace(prefix, '').replace(/\/$/, '')}</div>
                    <div class="file-size">-</div>
                    <div class="file-actions"></div>
                </li>
            `;
        });

        // 3. å®‰å…¨å¤„ç†æ–‡ä»¶åˆ—è¡¨
        const files = result.objects || []; // ç¡®ä¿å§‹ç»ˆæ˜¯æ•°ç»„
        files.forEach(file => {
          // è·³è¿‡ç›®å½•æ ‡è®°ï¼ˆä»¥/ç»“å°¾çš„æ¡ç›®ï¼‰
          if (file.name.endsWith('/')) return;

          const fileName = file.name.replace(prefix, '');
          const fileUrl = client.signatureUrl(file.name);
          const fileSize = formatFileSize(file.size);

          content += `
                <li class="file-item">
                    <div class="file-icon">ğŸ“„</div>
                    <div class="file-name">${fileName}</div>
                    <div class="file-size">${fileSize}</div>
                    <div class="file-actions">
                        <a href="${fileUrl}" target="_blank">æŸ¥çœ‹</a>
                        <a href="${fileUrl}" download>ä¸‹è½½</a>
                    </div>
                </li>
            `;
        });

        content += '</ul>';

        // å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œæ˜¾ç¤ºæç¤º
        if (folders.length === 0 && files.filter(f => !f.name.endsWith('/')).length === 0) {
          content = '<div class="empty">å½“å‰ç›®å½•ä¸ºç©º</div>';
        }

        container.innerHTML = content;

      } catch (error) {
        console.error('åˆ—å‡ºæ–‡ä»¶å¤±è´¥:', error);
        document.getElementById('file-list-container').innerHTML = `
            <div class="error">
                <strong>åŠ è½½å¤±è´¥:</strong> ${error.message}<br>
                ${error.code ? `é”™è¯¯ä»£ç : ${error.code}` : ''}
            </div>
        `;
      }
    };

    // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
    const updateBreadcrumb = (prefix) => {
      const parts = prefix.split('/').filter(p => p);
      let breadcrumb = '<a href="javascript:void(0)" onclick="listFiles(\'\')">æ ¹ç›®å½•</a>';

      let currentPath = '';
      parts.forEach(part => {
        currentPath += part + '/';
        breadcrumb += ` / <a href="javascript:void(0)" onclick="listFiles('${currentPath}')">${part}</a>`;
      });

      document.getElementById('breadcrumb').innerHTML = breadcrumb;
    };

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    const formatFileSize = (bytes) => {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    };

    // åˆå§‹åŒ–åŠ è½½æ ¹ç›®å½•
    window.onload = () => listFiles('');
  </script>
</body>

</html>